<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CoGbx Registry Viewer v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #050812;
      color: #e6f0ff;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.75;
      margin-bottom: 1rem;
    }
    .status {
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .status span.label {
      opacity: 0.7;
    }
    .pill {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(150, 200, 255, 0.4);
      font-size: 0.75rem;
      margin-right: 0.35rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid rgba(90, 110, 150, 0.7);
      padding: 0.45rem 0.55rem;
      vertical-align: top;
    }
    th {
      background: rgba(20, 35, 70, 0.9);
      text-align: left;
    }
    tr:nth-child(even) td {
      background: rgba(10, 18, 40, 0.7);
    }
    tr:nth-child(odd) td {
      background: rgba(7, 12, 30, 0.7);
    }
    .code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    .chip-row {
      margin-top: 0.25rem;
    }
    .muted {
      opacity: 0.7;
    }
    .error {
      color: #ffb3c1;
    }
    .warning {
      color: #ffe08a;
    }
    a {
      color: #8ecbff;
    }
  </style>
</head>
<body>
  <h1>CoGbx Registry Viewer v1</h1>
  <div class="subtitle">
    Backed by CoIndex &mdash; CoBus (wire) &rarr; CoGibber (language) &rarr; CoGbx (views).
  </div>

  <div id="status" class="status"><span class="label">Status:</span> Loading registry…</div>

  <div id="content"></div>

  <script>
    async function loadRegistry() {
      const statusEl = document.getElementById("status");
      const contentEl = document.getElementById("content");

      function setStatus(text, cssClass) {
        statusEl.textContent = "";
        const label = document.createElement("span");
        label.className = "label";
        label.textContent = "Status: ";
        statusEl.appendChild(label);

        const msg = document.createElement("span");
        if (cssClass) msg.classList.add(cssClass);
        msg.textContent = text;
        statusEl.appendChild(msg);
      }

      try {
        // Relative path assumes this file is served from the repo root or equivalent.
        const resp = await fetch("../../gibber/cogibber.registry.v1.json").catch(() => null);

        if (!resp || !resp.ok) {
          setStatus("Could not load cogibber.registry.v1.json (check exports/gibber/).", "warning");
          contentEl.innerHTML = "<div class='section muted'>No registry file found at exports/gibber/cogibber.registry.v1.json.</div>";
          return;
        }

        const data = await resp.json();
        setStatus("Registry loaded.", "");

        const section = document.createElement("div");
        section.className = "section";

        const meta = document.createElement("div");
        meta.className = "muted";
        const ns = data.namespace || data.name || "unknown-namespace";
        const ver = data.version || data.schema_version || "v1";
        meta.textContent = "namespace: " + ns + "  ·  version: " + ver;
        section.appendChild(meta);

        const pointees = Array.isArray(data.pointees) ? data.pointees : null;

        if (!pointees || pointees.length === 0) {
          // Fallback: show raw JSON.
          const raw = document.createElement("pre");
          raw.className = "code";
          raw.textContent = JSON.stringify(data, null, 2);
          section.appendChild(document.createElement("br"));
          section.appendChild(raw);
          contentEl.appendChild(section);
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["id", "title/label", "repo:path", "category", "tags", "sensitivity"].forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        pointees.forEach(p => {
          const tr = document.createElement("tr");

          function tdText(val) {
            const td = document.createElement("td");
            td.textContent = val || "";
            return td;
          }

          const id = p.id || p.key || "";
          tr.appendChild(tdText(id));

          const label = p.label || p.title || p.name || "";
          tr.appendChild(tdText(label));

          const repo = p.repo || p.slug || "";
          const path = p.path || p.file || "";
          tr.appendChild(tdText(repo && path ? (repo + ":" + path) : (repo || path)));

          const cat = p.category || p.lens || "";
          tr.appendChild(tdText(cat));

          const tagsTd = document.createElement("td");
          const tags = p.tags || p.keywords || [];
          if (Array.isArray(tags) && tags.length > 0) {
            const row = document.createElement("div");
            row.className = "chip-row";
            tags.forEach(t => {
              const pill = document.createElement("span");
              pill.className = "pill";
              pill.textContent = t;
              row.appendChild(pill);
            });
            tagsTd.appendChild(row);
          } else {
            tagsTd.textContent = "";
          }
          tr.appendChild(tagsTd);

          const sens = p.sensitivity || p.tier || "";
          tr.appendChild(tdText(sens));

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        section.appendChild(table);
        contentEl.appendChild(section);

      } catch (err) {
        setStatus("Error loading registry: " + err, "error");
        const pre = document.createElement("pre");
        pre.className = "code error";
        pre.textContent = String(err);
        contentEl.appendChild(pre);
      }
    }

    loadRegistry();
  </script>
</body>
</html>
