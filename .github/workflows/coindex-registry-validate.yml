name: CoIndex registry validate

on:
  pull_request:
    paths:
      - "exports/gibber/**"
      - "schemas/**"
      - ".github/workflows/coindex-registry-validate.yml"

jobs:
  validate-registry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install jsonschema
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate cogibber.registry.v1.json
        run: |
          if [ ! -f "exports/gibber/cogibber.registry.v1.json" ]; then
            echo "No registry file present, skipping validation."
            exit 0
          fi

          python - << "EOF"
          import json, sys
          from jsonschema import validate, ValidationError

          with open("schemas/cogibber.registry.v1.schema.json", "r", encoding="utf-8") as f:
              schema = json.load(f)

          with open("exports/gibber/cogibber.registry.v1.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          try:
              validate(data, schema)
          except ValidationError as e:
              print("Registry schema validation FAILED")
              print(e)
              sys.exit(1)

          print("Registry schema validation OK")
          EOF
